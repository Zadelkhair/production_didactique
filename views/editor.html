<!doctype html>
<html lang="en">

<head>
    <title>Title</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS v5.0.2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <link rel="stylesheet" href="/static/codemirror-5.65.3/theme/abbott.css">

    <style>
        body {
            overflow: hidden;
        }

        hr {
            margin: 5px 0;
            border: solid 1px rgba(0, 0, 0, 0.041);
            width: 100%;
        }

        #app {
            height: 100%;
            width: 100%;
        }

        #controls {
            width: 200px;
            position: absolute;
            right: 10px;
            top: 10px;
            display: flex;
            background: white;
            border: solid rgb(238, 238, 238);
            border-width: 1px;
            padding: 10px;
            flex-direction: column;
            align-items: center;
            height: calc(100% - 10px*2);
            box-shadow: 0 0 20px 0 #0000001c;
            opacity: .2;
            transition: 1s ease;
        }

        #controls:hover {
            opacity: 1;
        }

        #controls * {
            font-size: 12px !important;
        }

        #timeline {
            display: flex;
            height: 200px;
            background: rgb(240, 240, 240);
            width: 100%;
            flex-direction: column;
            overflow-y: scroll;
            padding: 4px 2px 4px 4px;
        }

        #timeline::-webkit-scrollbar {
            width: 3px;
        }

        #timeline::-webkit-scrollbar-track {}

        #timeline::-webkit-scrollbar-thumb {
            background-color: darkgrey;
        }

        .timeline-item {
            padding: 2px 5px;
            display: flex;
            align-items: center;
            background: rgb(253, 253, 253);
            margin-bottom: 3px;
            border: 1px solid gainsboro;
        }

        .timeline-item:hover {
            background: rgb(248, 248, 248);
            cursor: pointer;
        }

        .timeline-item-selected {
            background-color: #0d6efd;
            border-color: #0d6efd;
            color: white;
        }

        .timeline-item-selected * {
            color: white;
        }

        .timeline-item-selected:hover {
            background-color: #0b5ed7;
            border-color: #0a58ca;
        }

        .my-btn {
            border-style: none;
            background: transparent;
            text-align: center;
            justify-content: center;
            display: flex;
            margin: 0;
            padding: 3px;
        }

        .my-btn:hover {
            font-weight: bold;
        }

        #proprieties {
            display: flex;
            height: 200px;
            width: 100%;
            flex-direction: column;
            overflow-y: scroll;
            padding: 4px 2px 4px 4px;
            background: rgb(240, 240, 240);
        }

        #proprieties::-webkit-scrollbar {
            width: 3px;
        }

        #proprieties::-webkit-scrollbar-track {}

        #proprieties::-webkit-scrollbar-thumb {
            background-color: darkgrey;
        }

        .prop {
            font-size: 12px;
            padding: 2px 5px;
            display: flex;
            flex-direction: column;
            margin-bottom: 3px;
        }

        .prop input {
            margin: 0;
        }

        #proprieties .label-group {
            font-size: 12px;
            font-weight: bold;
        }

        .my-btn-delete {
            padding: 0;
            margin: 0;
            background: transparent;
            border: none;
            color: red;
        }

        .my-btn-delete:hover {
            font-weight: bold;
        }
    </style>

    <style id="part_style">
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.10.4/gsap.min.js"></script>
    <script src="https://unpkg.com/vue@3"></script>
    <link rel="stylesheet" href="/static/codemirror-5.65.3/lib/codemirror.css">
    <link rel="stylesheet" href="/static/codemirror-5.65.3/addon/hint/show-hint.css">
    <script src="/static/codemirror-5.65.3/lib/codemirror.js"></script>
    <script src="/static/codemirror-5.65.3/addon/hint/show-hint.js"></script>
    <script src="/static/codemirror-5.65.3/addon/hint/xml-hint.js"></script>
    <script src="/static/codemirror-5.65.3/addon/hint/html-hint.js"></script>
    <script src="/static/codemirror-5.65.3/mode/xml/xml.js"></script>
    <script src="/static/codemirror-5.65.3/mode/javascript/javascript.js"></script>
    <script src="/static/codemirror-5.65.3/mode/css/css.js"></script>
    <script src="/static/codemirror-5.65.3/mode/htmlmixed/htmlmixed.js"></script>
    <script src="/static/codemirror-5.65.3/addon/selection/active-line.js"></script>
    <script src="/static/codemirror-5.65.3/addon/edit/matchbrackets.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.27.2/axios.min.js"
        integrity="sha512-odNmoc1XJy5x1TMVMdC7EMs3IVdItLPlCeL5vSUPN2llYKMJ2eByTTAIiiuqLg+GdNr9hF6z81p27DArRFKT7A=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        .CodeMirror {
            border: 1px solid black;
            font-size: 13px
        }

        .CodeMirror-hints {
            z-index: 9999;
        }
    </style>
</head>

<body>

    <div id="app">


        <div class="modal fade" id="html-editor-modal" tabindex="-1" role="dialog" aria-labelledby="my-modal-title"
            aria-hidden="true">
            <div class="modal-dialog modal-xl" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="my-modal-title">html editor</h5>
                        <button class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div id="codehtml"></div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" type="button" @click="saveHtml()">save</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="css-editor-modal" tabindex="-1" role="dialog" aria-labelledby="my-modal-title"
            aria-hidden="true">
            <div class="modal-dialog modal-xl" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="my-modal-title">css editor</h5>
                        <button class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div id="codecss"></div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" type="button" @click="saveCss()">save</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="script-editor-modal" tabindex="-1" role="dialog" aria-labelledby="my-modal-title"
            aria-hidden="true">
            <div class="modal-dialog modal-xl" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="my-modal-title">script editor</h5>
                        <button class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div id="codescript"></div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" type="button" @click="saveScript()">save</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="admin-script-editor-modal" tabindex="-1" role="dialog"
            aria-labelledby="my-modal-title" aria-hidden="true">
            <div class="modal-dialog modal-xl" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="my-modal-title">admin script editor</h5>
                        <button class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div id="adminscript"></div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" type="button" @click="saveAdminScript()">save</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="new-gsap-modal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-body">
                        <div class="d-flex flex-column">
                            <label for="">id :</label>
                            <input v-model="newGsap.id" class="form-control" type="text">
                            <hr>
                            <label for="">type :</label>
                            <input type="text" v-model="newGsap.type" class="form-control" list="gsaptypes" />
                            <datalist id="gsaptypes">
                                <option v-for="(objType,key) in objTypes" :key="key">{{objType}}</option>
                            </datalist>
                            <hr>
                            <button class="btn btn-primary" @click="saveNewGsap()" type="button">save</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="new-prop-modal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-body">
                        <div class="d-flex flex-column">
                            <label for="">name :</label>
                            <input id="new-prop-input" v-model="newPropName" class="form-control" type="text">
                            <button class="btn btn-primary" @click="saveNewProp()" type="button">
                                save
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="new-from-prop-modal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-body">
                        <div class="d-flex flex-column">
                            <label for="">name :</label>
                            <input id="new-from-prop-input" v-model="newPropName" class="form-control" type="text"
                                name="">
                            <button class="btn btn-primary" @click="saveNewFromProp()" type="button">save</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="new-to-prop-modal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-body">
                        <div class="d-flex flex-column">
                            <label for="">name :</label>
                            <input id="new-to-prop-input" v-model="newPropName" class="form-control" type="text"
                                name="">
                            <button class="btn btn-primary" @click="saveNewToProp()" type="button">save</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <span v-html="html"></span>
        <div id="controls">
            <div class="d-flex mb-2">
                <button class="btn btn-sm btn-success me-2" @click="load()" type="button">load</button>
                <button class="btn btn-sm btn-success" @click="save()" type="button">
                    <span
                        v-if="(dataStatus.html>0 || dataStatus.css>0 || dataStatus.gsap>0 || dataStatus.script>0 )">*</span>
                    save
                </button>
            </div>
            <hr>

            <!-- <label id="ani-progress" class="control">{{progress}} %</label> -->
            <div class="d-flex align-items-center">
                <input class="me-2" type="number" :value="parseInt(progress*100)" @change="progressChanged">%
            </div>
            <div class="d-flex align-items-center my-2">
                <button class="btn btn-sm btn-primary me-2" id="btn-play" disabled @click="resume()"
                    type="button">play</button>
                <button class="btn btn-sm btn-primary" id="btn-pause" disabled @click="pause()"
                    type="button">pause</button>

            </div>
            <hr>
            <label for="">editor :</label>
            <div class="d-flex flex-wrap justify-content-center item-align-center">
                <button class="btn btn-sm ms-2 mb-2 btn-primary" @click="editHtml()" type="button">html</button>
                <button class="btn btn-sm ms-2 mb-2 btn-primary" @click="editCss()" type="button">css</button>
                <button class="btn btn-sm ms-2 mb-2 btn-primary" @click="editScript()" type="button">script</button>
                <button class="btn btn-sm ms-2 mb-2 btn-primary" @click="editAdminScript()" type="button">admin
                    script</button>
            </div>
            <hr>
            <label for="">timeline :</label>
            <div id="timeline">
                <div v-for="(gsitem,key) in gsap" @click="selectGsap(gsitem)" :key="key" class="timeline-item"
                    :class="selected_gsap==gsitem?'timeline-item-selected':''">
                    <label for="">{{ gsitem.id }} ({{ gsitem.type }})</label>
                    <button class="my-btn ms-auto" @click.stop="upGsap(key)">up</button>
                    <button class="my-btn m-0" @click.stop="downGsap(key)">down</button>
                    <button class="my-btn-delete m-0" @click.stop="deleteGsap(key)">x</button>
                </div>
                <button @click="modalNewGsap()" class="btn btn-sm bg-white" type="button">+</button>
            </div>
            <hr>
            <label for="">proprieties :</label>
            <div id="proprieties">
                <template v-if="selected_gsap">
                    <template v-for="(prop,key) in selected_gsap">
                        <div v-if="typeof prop !== 'object'" :key="key" class="prop">
                            <div class="d-flex">
                                <label for="">{{key}} :</label>
                                <button @click.stop="deleteProp(key)" class="ms-auto my-btn-delete">x</button>
                            </div>
                            <input :type="gsap_inputs[key]?.type??text" :step="gsap_inputs[key]?.step??1"
                                v-model="selected_gsap[key]">
                        </div>
                    </template>
                    <div class="prop">
                        <button class="btn btn-sm bg-white" @click="modalNewProp()" type="button">+</button>
                    </div>
                </template>
                <template v-if="selected_gsap.from">
                    <label class="label-group" for="">from :</label>
                    <div v-for="(prop,key) in selected_gsap.from" :key="key" class="prop">
                        <div class="d-flex">
                            <label for="">{{key}} :</label>
                            <button @click.stop="deleteFromProp(key)" class="ms-auto my-btn-delete">x</button>
                        </div>
                        <input :type="gsap_inputs[key]?.type??text" v-model="selected_gsap.from[key]">
                    </div>
                    <div class="prop">
                        <button class="btn btn-sm bg-white" @click="modalNewFromProp()" type="button">+</button>
                    </div>
                </template>
                <template v-if="selected_gsap.to">
                    <label class="label-group" for="">to :</label>
                    <div v-for="(prop,key) in selected_gsap.to" :key="key" class="prop">
                        <div class="d-flex">
                            <label for="">{{key}} :</label>
                            <button @click.stop="deleteToProp(key)" class="ms-auto my-btn-delete">x</button>
                        </div>
                        <input :type="gsap_inputs[key]?.type??text" v-model="selected_gsap.to[key]">
                    </div>
                    <div class="prop">
                        <button class="btn btn-sm bg-white" @click="modalNewToProp()" type="button">+</button>
                    </div>
                </template>
            </div>

        </div>
    </div>

    <!-- Bootstrap JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
        integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"
        integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF"
        crossorigin="anonymous"></script>

    <script id="part_script"></script>
    <script id="part_admin_script"></script>

    <script>

        //get the style element where we will put the part css
        let styleElem = document.getElementById('part_style');
        //get the script element where we will put the part script
        let scriptElem = document.getElementById('part_script');
        // admin script element where we will put the admin script
        let adminScriptElem = document.getElementById('part_admin_script');

        let tl, htmlEditor, cssEditor, scriptEditor, adminScriptEditor

        //the timeline
        tl = gsap.timeline();

        let app = Vue.createApp({
            data() {
                return {
                    objTypes: [
                        'object',
                        'video',
                        'videoplayer',
                        'audio',
                        'label',
                        'goto',
                        'customefunction',
                    ],
                    dataStatus: {
                        css: -1,
                        html: -1,
                        gsap: -1,
                        script: -1,
                        adminscript: -1,
                    },
                    part: {},
                    progress: 0,
                    css: '',
                    html: '',
                    script: '',
                    admin_script: '',
                    newPropName: '',
                    gsap: [],
                    selected_gsap: {},
                    gsap_inputs: {
                        width: {
                            type: "text"
                        },
                        height: {
                            type: "text"
                        },
                        top: {
                            type: "text"
                        },
                        left: {
                            type: "text",
                        },
                        opacity: {
                            type: "number",
                            step: 0.1
                        }
                    },
                    newGsap: {},
                    endTimeline:false,
                    playingVideos:[]
                }
            },
            watch: {
                css(newV, oldV) {
                    styleElem.innerHTML = newV;
                    //to check how many time the css has been changed
                    this.dataStatus.css++;
                },
                html(newV, oldV) {
                    this.dataStatus.html++;
                },
                script(newV, oldV) {
                    scriptElem.innerHTML = newV;
                    this.dataStatus.script++;
                },
                admin_script(newV, oldV) {
                    adminScriptElem.innerHTML = newV;
                    this.dataStatus.adminscript++;
                },
                gsap: {
                    handler(newValue, oldValue) {
                        this.dataStatus.gsap++;
                    },
                    deep: true
                },
                selected_gsap: {
                    handler(newValue, oldValue) {
                        /*
                        * if the selected gsap has been changed we will reload the timeline 
                        * from current timeline progress 
                        */
                        this.load(tl.progress());
                    },
                    deep: true
                }
            },
            mounted() {

                //if the url not contains id of evaluation_part go main
                var url = window.location.href;
                if (!url.includes('id')) {
                    window.location.href = '/';
                }

                //get evaluation part id
                url = new URL(url);
                var idEvaluationPart = url.searchParams.get('id');

                //loading the animation part
                axios.get('/api/evaluationpart?id=' + idEvaluationPart)
                    .then((response) => {

                        this.part = response.data;

                        //fill our vue data with the response data
                        this.css = this.part.css;
                        this.html = this.part.html;
                        this.script = this.part.script;
                        this.admin_script = this.part.admin_script;
                        this.gsap = JSON.parse(this.part.gsap)??[];
                        this.id = this.part.id;

                        //initialize the timeline for new use
                        tl = gsap.timeline();

                        //initilize the editors
                        htmlEditor = CodeMirror(document.getElementById("codehtml"), {
                            mode: "text/html",
                            extraKeys: { "Ctrl-Space": "autocomplete" },
                            // lineNumbers: true,
                            styleActiveLine: true,
                            theme: "abbott"
                        });
                        cssEditor = CodeMirror(document.getElementById("codecss"), {
                            mode: "text/css",
                            extraKeys: { "Ctrl-Space": "autocomplete" },
                            // lineNumbers: true,
                            styleActiveLine: true,
                            matchBrackets: true,
                            theme: "abbott"
                        });
                        scriptEditor = CodeMirror(document.getElementById("codescript"), {
                            mode: "javascript",
                            extraKeys: { "Ctrl-Space": "autocomplete" },
                            // lineNumbers: true,
                            styleActiveLine: true,
                            matchBrackets: true,
                            theme: "abbott"
                        });
                        adminScriptEditor = CodeMirror(document.getElementById("adminscript"), {
                            mode: "javascript",
                            extraKeys: { "Ctrl-Space": "autocomplete" },
                            // lineNumbers: true,
                            styleActiveLine: true,
                            matchBrackets: true,
                            theme: "abbott"
                        });

                        //update input progress every 0.1 sec
                        setInterval(() => {
                            if (this.progress != tl.progress())
                                this.progress = tl.progress();
                        }, 100);

                        //this.load();


                    })
                    .catch(function (error) {
                        // handle error
                        // window.location.href = '/';
                        console.log(error);
                    })

            },
            methods: {
                loadVideoResources(resources, callback) {

                    //if resources is null go out from function
                    if (resources.length == 0)
                        callback();

                    //the loaded data to chek if all resources has been loaded
                    let loaded = 0;
                    let canPlay = 0;
                    let error = 0;

                    //loop throuph all resources and load theme
                    resources.forEach((rs) => {
                        //get resource element to load the video on it
                        let vid = document.querySelector(rs.id);

                        //if the element not exist create it
                        if (!vid) {
                            vid = document.createElement('video');
                            vid.id = rs.id.substring(1);
                            // add element to #app element
                            document.getElementById('app').appendChild(vid);
                            //add d-note class
                            vid.classList.add('d-none');
                        }

                        if (vid) {
                            var new_element = vid.cloneNode(true);
                            vid.parentNode.replaceChild(new_element, vid);
                        }
                        vid = document.querySelector(rs.id);

                        console.log(vid);

                        if (!rs.url) {
                            rs.url = '/static/err.mp3';
                        }

                        //stop if vid is null
                        if (!vid) {
                            return;
                        }

                        vid.src = rs.url;
                        vid.load();

                        //if the video is not valid
                        vid.addEventListener("error", () => {
                            //we will encriment the loaded, bcz the video is not valid
                            error++;
                            console.log('error : ', error, vid.src);
                            if (canPlay + error == resources.length) {
                                //we will call the callback function if all resources loaded
                                callback();
                            }
                        }, true);

                        //to check if the element has a valid video
                        vid.addEventListener("loadeddata", () => {

                            //load the video

                            //it will be incrimented on every load
                            // and we will check if all video has been loaded!
                            canPlay++;
                            console.log('can play : ', canPlay, vid.src);
                            if (canPlay + error == resources.length) {
                                //we will call the callback function if all resources loaded
                                callback();
                            }

                            // //event whene the first frame will loaded
                            // vid.addEventListener('loadeddata', () => {


                            // }, false);

                            //we will remove all event listener after ending the media
                            vid.addEventListener('ended', () => {
                                if (vid) {
                                    var new_element = vid.cloneNode(true);
                                    vid.parentNode.replaceChild(new_element, vid);
                                }
                            })

                        });

                        // return;

                    });
                    // callback();
                },
                async load(p = 0) {

                    // it will pause the animation if it still playing
                    this.pause(p);

                    //initialize the timeline for new use
                    tl = gsap.timeline();

                    //this variable will hold all the resources that chould be loaded
                    let resources = [];

                    //loop throuph the gsap list and check if there any video animation
                    this.gsap.forEach((v) => {
                        if (v.type == 'videoplayer') {
                            resources.push({
                                id: v.id,
                                url: v.url
                            });
                        }
                    });

                    //load all the videos and wait untill they loaded
                    this.loadVideoResources(resources, () => {

                        //tl = gsap.timeline();

                        //we will use this variable to check if the time line has been ended or not
                        this.endTimeline = false;

                        //playing video list
                        this.playingVideos = [];

                        //start the animations
                        this.gsap.forEach((obj) => {

                            //do some work based on the type of gsap item's
                            if (obj.type == 'object') {
                                tl.fromTo(obj.id, { ...obj.from }, { ...obj.to }, obj.at);
                            }
                            else if (obj.type == 'video') {
                                tl.fromTo(obj.id, { ...obj.from }, { ...obj.to }, obj.at);
                            }
                            else if (obj.type == 'videoplayer') {
                                //we will play the videos inside a call function
                                // the GSAP don't support videos
                                //to add this feature we will stop the animation untill the end of the video
                                // and we will play the video again 
                                tl.call(() => {

                                    //if the timeline is paused then we should'nt play the video
                                    if (tl.paused()) return;

                                    //get the video id without hashtag '#' from the gsap item
                                    let videoId = obj.id.replace('#', '');

                                    //get the element by the video id
                                    var vid1 = document.getElementById(videoId);

                                    //play the video
                                    vid1.play();

                                    //add event waiting the video untill it start playing
                                    vid1.addEventListener("play", () => {

                                        //add the video id the the playing video list
                                        //we need this variable to check if there any video still playing
                                        this.playingVideos.push(videoId);

                                        // we will add some labels to the timeline
                                        // we need inside the pause and play functions
                                        // to decide if we should play the video or the animation
                                        let label = `vid@${videoId}`;

                                        //we add this to add the possibility of playing the video along with animations
                                        //we will add the some string to use it inside pause and play function
                                        //bcz if the video is playing along with the animation we should pause/play them bouth
                                        if (obj.playwith)
                                            label += '@playwith';

                                        console.log(label,'add lable');

                                        //add lable to the timeline
                                        tl.addLabel(label);

                                        //if the video is not playing with animation we should pause the animation untill the video ended
                                        if (!obj.playwith)
                                            tl.pause();

                                        console.log(label);

                                        //on the video ended we should play the animation
                                        vid1.onended = () => {

                                            //algorithm to delete the video from the playing video list
                                            var vindex = this.playingVideos.indexOf(videoId);
                                            if (vindex !== -1) {
                                                this.playingVideos.splice(vindex, 1);
                                            }

                                            //remove the video label from timeline
                                            tl.removeLabel(label);

                                            //if the video is playing with then the animation is alredy playing
                                            if (!obj.playwith)
                                                tl.resume();

                                            //if the playing list is empty and the timeline is ended, we will stop the timeline
                                            if (this.playingVideos.length == 0 && this.endTimeline) {
                                                this.stop();
                                            }

                                        }

                                    });


                                }, null, obj.at);
                            }
                            else if (obj.type == 'label') {
                                //add label to the timeline
                                tl.addLabel(obj.name);
                            }
                            else if (obj.type == 'goto') {
                                //jump to a specific label
                                tl.call(() => tl.seek(obj.label), null, obj.at)
                            }
                            else if (obj.type == 'customefunction') {
                                //execute the custom function in timeline call
                                tl.call(() => {

                                    if (obj.wait) {
                                        //check if the tl is already paused 
                                        let paused = tl.paused();

                                        this.pause();
                                        part[obj.func](() => {
                                            if (paused) return;
                                            // this.play();
                                        });

                                    }
                                    else {
                                        part[obj.func]();
                                    }

                                }, null, obj.at)
                            }
                        
                        });

                        //this call function will be called whene the animation is ended
                        tl.call(() => {

                            //we will set the this.endTimeline to true bcz the animmation is ended
                            //we will use this variable to stop the animation if the video is still playing
                            this.endTimeline = true;

                            //if the playing list already containing some videos we should not stoping the animations
                            if (this.playingVideos.length != 0)
                                return;

                            //stop the animation
                            this.stop();
                        });

                        //pause untill we press the play button
                        tl.pause();

                        //we can jump on a specific progress in timeline with the p variable
                        tl.progress(p);

                        document.getElementById('btn-play').disabled = false;

                    });

                },
                //if the user change the progress bar we will jump to the chosen progress on the timeline and pause it
                progressChanged(e) {
                    let val = e.target.value;
                    tl.progress(val / 100);
                    this.pause();
                },
                //stop the timeline & reload it
                stop() {
                    tl.pause();
                    this.selectPart();
                    // tl = gsap.timeline();
                    // this.load();
                },
                //play function will play the animation
                play(p = null) {

                    //we will check first if the timeline is paused on a video
                    if (tl.nextLabel()?.indexOf('vid') == 0) {

                        //split the label and get the id of the video & the type of playing (playing with or not)
                        let splitedLabel = tl.nextLabel().split('@');

                        //check if the label is containing more than 2 parameters.
                        //if not you should go out from the function
                        if (splitedLabel.length < 2)
                            return;

                        //initializing the playwith with false
                        let playwith = false;

                        //if the label containing 3 parameters and the 3'd paramater is playingwith then change the playwith variable to true
                        if (splitedLabel.length > 2)
                            if (splitedLabel[2] == 'playwith')
                                playwith = true;

                        //get the id of the played video 
                        var vidid = splitedLabel[1];

                        //get the element of the played video using the id to play it
                        var currVid = document.getElementById(vidid);

                        //play the video
                        currVid.play();

                        //enable pause button and play button
                        document.getElementById('btn-play').disabled = true;
                        document.getElementById('btn-pause').disabled = false;

                        //if the video is not playing with the animation go out without playing the animation
                        // if not we should pass to the next instruction's to play the animations
                        if (!playwith)
                            return;
                    }

                    //play the timeline animation
                    tl.play(p);
                    //enable the pause button & disable the play button
                    document.getElementById('btn-play').disabled = true;
                    document.getElementById('btn-pause').disabled = false;

                },
                pause(p = null) {

                    console.log('pause video',tl.nextLabel());

                    //check if the animation is curently playing a video
                    if (tl.nextLabel()?.indexOf('vid') == 0) {


                        let splitedLabel = tl.nextLabel().split('@');

                        if (splitedLabel.length < 2)
                            return;

                        let playwith = false;

                        if (splitedLabel.length > 2)
                            if (splitedLabel[2] == 'playwith')
                                playwith = true;

                        var vidid = splitedLabel[1];

                        var currVid = document.getElementById(vidid);
                        //if the video is played then pause it
                        currVid.pause();
                        document.getElementById('btn-play').disabled = false;
                        document.getElementById('btn-pause').disabled = true;
                        // return;
                    }

                    //if 'p' is not null then pause the animation on a specific progress
                    if (p)
                        tl.progress(p);
                    tl.pause();

                    document.getElementById('btn-play').disabled = false;
                    document.getElementById('btn-pause').disabled = true;
                },
                //it will do the same functionality of play but it will resume the animation from both derictions (reverse or simple)
                resume() {

                    // if (!tl.isActive() && (tl.progress() == 0 || tl.progress() == 1)) {
                    //     this.play(0);
                    //     return;
                    // }

                    if (tl.nextLabel()?.indexOf('vid') == 0) {

                        let splitedLabel = tl.nextLabel().split('@');

                        if (splitedLabel.length < 2)
                            return;

                        let playwith = false;

                        if (splitedLabel.length > 2)
                            if (splitedLabel[2] == 'playwith')
                                playwith = true;

                        var vidid = splitedLabel[1];

                        var currVid = document.getElementById(vidid);
                        currVid.play();
                        document.getElementById('btn-play').disabled = true;
                        document.getElementById('btn-pause').disabled = false;

                        if (!playwith)
                            return;
                    }

                    tl.resume();
                    document.getElementById('btn-play').disabled = true;
                    document.getElementById('btn-pause').disabled = false;
                },
                editHtml() {
                    $('#html-editor-modal').modal('show');
                    htmlEditor.setValue(this.html);
                },
                editCss() {
                    $('#css-editor-modal').modal('show');
                    cssEditor.setValue(this.css);
                },
                editScript() {
                    $('#script-editor-modal').modal('show');
                    scriptEditor.setValue(this.script ?? '');
                },
                editAdminScript() {
                    $('#admin-script-editor-modal').modal('show');
                    adminScriptEditor.setValue(this.admin_script ?? '');
                },
                saveHtml() {
                    this.html = htmlEditor.getValue();
                    $('#html-editor-modal').modal('hide');
                },
                saveCss() {
                    this.css = cssEditor.getValue();
                    $('#css-editor-modal').modal('hide');
                },
                saveScript() {
                    this.script = scriptEditor.getValue();
                    $('#script-editor-modal').modal('hide');
                },
                saveAdminScript() {
                    this.admin_script = adminScriptEditor.getValue();
                    $('#admin-script-editor-modal').modal('hide');
                },
                selectGsap(gsitem) {
                    if (this.selected_gsap == gsitem) {
                        this.selected_gsap = {};
                        return;
                    }
                    this.selected_gsap = gsitem;
                },
                modalNewGsap() {
                    this.newGsap = {};
                    $('#new-gsap-modal').modal('show');
                },
                modalNewProp() {
                    this.newPropName = '';
                    $('#new-prop-modal').modal('show');
                },
                modalNewFromProp() {
                    this.newPropName = '';
                    $('#new-from-prop-modal').modal('show');
                },
                modalNewToProp() {
                    this.newPropName = '';
                    $('#new-to-prop-modal').modal('show');
                },
                saveNewProp() {
                    this.selected_gsap[this.newPropName] = "value";
                    $('#new-prop-modal').modal('hide');
                },
                saveNewFromProp() {
                    this.selected_gsap.from[this.newPropName] = "value";
                    $('#new-from-prop-modal').modal('hide');
                },
                saveNewToProp() {
                    this.selected_gsap.to[this.newPropName] = "value";
                    $('#new-to-prop-modal').modal('hide');
                },
                saveNewGsap() {
                    this.gsap.push({ ...this.newGsap, from: {}, to: {} });
                    $('#new-gsap-modal').modal('hide');
                },
                deleteProp(prop) {
                    delete this.selected_gsap[prop];
                },
                deleteFromProp(prop) {
                    delete this.selected_gsap.from[prop];
                },
                deleteToProp(prop) {
                    delete this.selected_gsap.to[prop];
                },
                deleteGsap(index) {
                    this.gsap.splice(index, 1);
                },
                upGsap(index) {

                    if (index <= 0)
                        return;

                    let temp = { ...this.gsap[index] };
                    this.gsap[index] = this.gsap[index - 1];
                    this.gsap[index - 1] = temp;

                },
                downGsap(index) {
                    if (index + 1 >= this.gsap.length)
                        return;

                    let temp = { ...this.gsap[index] };
                    this.gsap[index] = this.gsap[index + 1];
                    this.gsap[index + 1] = temp;

                },
                save() {
                    //save the animation part in the database
                    axios.post('/api/evaluationpart', {
                        name: this.part.name,
                        gsap: JSON.stringify(this.gsap),
                        html: this.html,
                        css: this.css,
                        script: this.script,
                        admin_script: this.admin_script,
                        id: this.part.id
                    })
                        .then((response) => {
                            console.log(response);
                            this.dataStatus = {
                                css: 0,
                                html: 0,
                                gsap: 0,
                                script: 0,
                                adminscript: 0
                            }
                        })
                        .catch(function (error) {
                            console.log(error);
                        });
                },
                getVideoElement(vidid, parentElement) {

                    //check if the video is already exist
                    var vid = document.getElementById(vidid);
                    if (vid) {
                        return vid;

                        //if the video is not exist create new one
                    } else {
                        var vid = document.createElement('video');
                        vid.id = vidid;
                        // add class d-note
                        vid.classList.add('d-note');

                        // add the video element to the parent element
                        parentElement.appendChild(vid);
                        return vid;
                    }
                }
            },
        }).mount('#app');

    </script>
</body>

</html>